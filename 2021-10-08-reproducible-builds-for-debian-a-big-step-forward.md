---
layout: post
title: "Reproducible Builds for Debian: a big step forward"
categories: articles
author: Frédéric Pierret
---

_This is the second article in the "Reproducible Builds" series.
Previously: Improvements in testing and building: GitLab CI and reproducible builds](https://www.qubes-os.org/news/2020/06/22/new-qrexec-policy-system/)._

In the previous article [Improvements in testing and building: GitLab CI and reproducible builds](https://www.qubes-os.org/news/2021/02/28/improvements-in-testing-and-building/#reproducible-builds), we discussed Reproducible Builds and our current short-term goals for them in Qubes OS. Notably, we aimed to start by building our Debian templates to a state, in which packages can be installed only when configured rebuilders confirm that they really came from the source code we publish. Today, we go beyond this expectation.

Reproducible Builds: retrieve the past
--------------------------------------

The challenge in Reproducible Builds lies in rebuilding a package in the same environement, in which it has been officialy published. It means that we need to retrieve every single package version that has been used as dependency to rebuild a given package. For Debian, some packages in the current release were built several releases in the past, but not necessary with the exact same dependencies. In order to retrieve them, there exist only one solution: a Debian service called `snapshot.debian.org`, which is an archive acting as a wayback machine that allows access to old packages based on dates and version numbers. It contains all past and current packages that the Debian archive provides. Unfortunately, this service is known to suffer significant blocking issues on usability. For example, you can watch a DebConf 2021 talk [Making use of snapshot.debian.org for fun and profit](https://debconf21.debconf.org/talks/22-making-use-of-snapshotdebianorg-for-fun-and-profit/ and have a look at some related Debian issues [#977653](https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=%977653), [#960304](https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=%960304), [#969906](https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=%969906), [#969603](https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=%969603), [#782857](https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=%782857). To summarize: there are throttling limits and availability issues such as repeatedly cutting off connection, returning partial content etc. As announced in our previous article, we developed our own rebuilder tool [debrebuild](https://github.com/fepitre/debrebuild), which is able to rebuild a single Debian package together with a rebuilder orchestrator [PackageRebuilder](https://github.com/fepitre/package-rebuilder). We started to put it in production in order to rebuild Qubes OS and Debian packages actively, but it ceased to function quickly, as `snapshot.debian.org` service was unable to sustain the load of rebuilding even a single Debian package. That said, the question was: how should we proceed in order to make it work? Clearly, those issues are critical and make the `snapshot.debian.org` service awful or useless for Reproducible Builds.

Is rebuilding Debian really possible?
-------------------------------------

The `snapshot.debian.org` issues are still not addressed even after several years. The service has existed since more than a decade, but still suffer from the above-mentioned limitations. It's either a problem of design, or a lack of resources to work on it, but something needed to be done.

That's why we decided to create our own [snapshot](https://github.com/fepitre/debian-snapshot) service. Easy to say, but not to do. First, the original snapshot service from Debian is roughly 90TB of repository data. Second, we cannot download files easily because only HTTP(s) is available and downloading multiple files means we are impeded by availability issues.
In order to work around the huge volume of data, we decided to get repositories from 2017 to today (it corresponds approximately to the moment where Debian `buster` was released) and only related architectures `amd64`, `source` and `all` (`all` stands for no specific architecture in Debian world). For the download part itself, we needed to parse the metadata of each Debian repository in order to get the list of files to download for every timestamp, for which a snapshot has been made. Then, we have developped `resume` and `retry` download functions, which unfortunately are brute force download functions. For storing the data, a simple approach has been employed: storing files as sha256 names, then creating symlinks to reconstruct repository layout. In order to get file information (packages and repository metadata), we rely on simply reading a symlink. It took 3-4 months to get 4.2TB of data, representing just 2017 (as of writing this article). Most of the information about the downloaded files and their source repository is stored in a database. In parallel, we added - like the original `snapshot.debian.org` - an API [snapshot-api](https://github.com/fepitre/debian-snapshot#API) to expose information about repositories. Unlike to the original one, we added much more information that rebuilder software, e.g. `debrebuild`, needs to have when requesting package information: such as the exact location of a given package in terms of Debian archive, timestamp, suite, architecture and component. The service is now publicly exposed at `https://snapshot.notset.fr` and the API endpoints at `https://snapshot.notset.fr/mr`. The service is home hosted by the author.

This is exactly where the dream of **rebuilding Debian packages** in the same environement that they have been officialy published in has became a **reality**. Thanks to our standalone orchestrator and rebuilder software `debrebuild`, results of rebuilding process, links to reproducible attestations called [in-toto metadata](https://in-toto.io/) or even why a package is not reproducible, can be found at `https://rebuild.notset.fr`. As of writing, we have successfully rebuilt more than 80% of latest Debian packages for `unstable` release while doing tests. Since it started, several adjustements have been made and we finally reached a stable rebuilding process. That is why after few late improvements during this almost first full rebuild, we flushed the whole and started it for latest Debian stable release `bullseye`. We would add again `unstable` just after the full rebuild of `bullseye`. As time is passing, we would have less and less pending tasks as there is still a couple of thousands package rebuilds to be done. Please notice that in addition to the initial package build, the process of rebuilding a package means: query multiple times `snapshot.notset.fr` API to get packages informations and locations, setup the same environment as the original published one and then, actually build it. All of this is possible thanks to several servers, home-hosted by the author, that intensively build packages non-stop for more than a month.

What's next?
------------

For Qubes OS, we already track reproducibility status in our continuous integrations tests (see the previous article about it) and they are also rebuilt independently like Debian packages, in the same Package Rebuilder instance. We have already most of the reproducible attestations for our specific Debian packages (see `https://rebuild.notset.fr/qubesos.html`) and soon all the needed ones for Debian. In consequence, that's why we are happy to announce that we already started the process of integrating the rebuild check status both at the build phase of our Debian templates and also when you would need to install a package later in the template itself. That's the reason we restarted the whole process of full rebuild for `bullseye`.

There exists preliminary work for handling Fedora into the orchestrator but that deserves another effort. The rebuilder [rpmreproduce](https://github.com/fepitre/rpmreproduce] can be used to rebuild Fedora packages but some discussions with RPM upstream is still needed (see https://github.com/rpm-software-management/rpm/pull/1532). Also, we plan to support other input than buildinfo file for RPM like Koji build description (build infrastructure used by Fedora and CentOS) or any description piece that would help knowing how a RPM package has been built. We plan also to add other distributions pretty easily and quickly like Archlinux as we are going to ship it officially soon.

Conclusion
----------

Improved documentation for the orchestrator is in progress to ease other people who want to rebuild Qubes OS or Debian in the same way that we are currently doing it. Especially, more independant rebuilders publishing reproducibility attestations the best it is for the community.

In all of those efforts, we are really satisfied that Reproducible Builds decided to use our work and results as an ambassador of what it was expecting since years, notably for Debian. The official website https://beta.tests.reproducible-builds.org currently redirects to our results website https://rebuild.notset.fr.

_The author thanks warmly Marta Marczykowska-Górecka and Marek Marczykowski-Górecki for their moral support and technical discussions into this rough and intensive journey while juggling between other projects._
